<html>
<head>
<title>main_final_SVM.ipynb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #abb2bf;}
.s1 { color: #59626f; font-style: italic;}
.s2 { color: #c679dd; font-style: italic;}
.s3 { color: #a6b2c0;}
.s4 { color: #98c379;}
.s5 { color: #61afef;}
.s6 { color: #d19a66;}
.ls0 { height: 1px; border-width: 0; color: #2e3c43; background-color:#2e3c43}
</style>
</head>
<body bgcolor="#282c34">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
main_final_SVM.ipynb</font>
</center></td></tr></table>
<pre><span class="s0">#%% 
</span>
<span class="s1"># Core data manipulation libraries</span>
<span class="s2">import </span><span class="s0">pandas </span><span class="s2">as </span><span class="s0">pd  </span><span class="s1"># For data manipulation and analysis</span>
<span class="s2">import </span><span class="s0">numpy </span><span class="s2">as </span><span class="s0">np  </span><span class="s1"># For numerical operations and array functionality</span>
<span class="s2">import </span><span class="s0">re  </span><span class="s1"># For regular expressions (text pattern matching)</span>

<span class="s1"># NLTK (Natural Language Toolkit) imports for text processing</span>
<span class="s2">import </span><span class="s0">nltk</span>
<span class="s2">from </span><span class="s0">nltk</span><span class="s3">.</span><span class="s0">tokenize </span><span class="s2">import </span><span class="s0">word_tokenize  </span><span class="s1"># Split text into individual words</span>
<span class="s2">from </span><span class="s0">nltk</span><span class="s3">.</span><span class="s0">corpus </span><span class="s2">import </span><span class="s0">stopwords  </span><span class="s1"># Common words to filter out (e.g., 'the', 'a', 'is')</span>
<span class="s2">from </span><span class="s0">nltk</span><span class="s3">.</span><span class="s0">stem </span><span class="s2">import </span><span class="s0">PorterStemmer  </span><span class="s1"># Reduce words to their root form (stem)</span>
<span class="s2">from </span><span class="s0">nltk</span><span class="s3">.</span><span class="s0">stem </span><span class="s2">import </span><span class="s0">WordNetLemmatizer  </span><span class="s1"># Reduce words to their dictionary form (lemma)</span>

<span class="s1"># Scikit-learn Pipeline for chaining preprocessing and model steps</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">pipeline </span><span class="s2">import </span><span class="s0">Pipeline</span>

<span class="s1"># Scikit-learn feature extraction tools for text vectorization</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">feature_extraction</span><span class="s3">.</span><span class="s0">text </span><span class="s2">import </span><span class="s0">CountVectorizer  </span><span class="s1"># Convert text to word count vectors</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">feature_extraction</span><span class="s3">.</span><span class="s0">text </span><span class="s2">import </span><span class="s0">TfidfTransformer  </span><span class="s1"># Transform counts to TF-IDF representation</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">feature_extraction</span><span class="s3">.</span><span class="s0">text </span><span class="s2">import </span><span class="s0">TfidfVectorizer  </span><span class="s1"># Combined CountVectorizer + TfidfTransformer</span>

<span class="s1"># Scikit-learn classification models</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">neighbors </span><span class="s2">import </span><span class="s0">KNeighborsClassifier  </span><span class="s1"># K-Nearest Neighbors classifier</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">naive_bayes </span><span class="s2">import </span><span class="s0">MultinomialNB  </span><span class="s1"># Naive Bayes classifier for text</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">svm </span><span class="s2">import </span><span class="s0">SVC  </span><span class="s1"># Support Vector Machine classifier</span>

<span class="s1"># Scikit-learn model selection and validation tools</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">model_selection </span><span class="s2">import </span><span class="s0">StratifiedKFold  </span><span class="s1"># Stratified K-fold cross-validation (maintains class distribution)</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">model_selection </span><span class="s2">import </span><span class="s0">KFold  </span><span class="s1"># Standard K-fold cross-validation</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">model_selection </span><span class="s2">import </span><span class="s0">train_test_split  </span><span class="s1"># Split data into train/test sets</span>

<span class="s1"># Scikit-learn evaluation metrics</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">metrics </span><span class="s2">import </span><span class="s0">accuracy_score  </span><span class="s1"># Calculate accuracy percentage</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">metrics </span><span class="s2">import </span><span class="s0">precision_score  </span><span class="s1"># Calculate precision (true positives / predicted positives)</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">metrics </span><span class="s2">import </span><span class="s0">recall_score  </span><span class="s1"># Calculate recall (true positives / actual positives)</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">metrics </span><span class="s2">import </span><span class="s0">f1_score  </span><span class="s1"># Calculate F1 score (harmonic mean of precision and recall)</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">metrics </span><span class="s2">import </span><span class="s0">classification_report  </span><span class="s1"># Generate comprehensive classification metrics</span>

<span class="s1"># Scikit-learn base classes for creating custom transformers</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">base </span><span class="s2">import </span><span class="s0">BaseEstimator</span><span class="s3">, </span><span class="s0">TransformerMixin  </span><span class="s1"># Base classes for custom pipeline components</span>

<span class="s1"># Gensim for word embeddings</span>
<span class="s2">from </span><span class="s0">gensim</span><span class="s3">.</span><span class="s0">models </span><span class="s2">import </span><span class="s0">Word2Vec  </span><span class="s1"># Train and use Word2Vec word embedding models</span>

<span class="s1"># TensorFlow/Keras for deep learning models</span>
<span class="s2">from </span><span class="s0">tensorflow</span><span class="s3">.</span><span class="s0">keras</span><span class="s3">.</span><span class="s0">models </span><span class="s2">import </span><span class="s0">Sequential  </span><span class="s1"># Sequential neural network model</span>
<span class="s2">from </span><span class="s0">tensorflow</span><span class="s3">.</span><span class="s0">keras</span><span class="s3">.</span><span class="s0">layers </span><span class="s2">import </span><span class="s0">LSTM</span><span class="s3">, </span><span class="s0">Dense</span><span class="s3">, </span><span class="s0">Embedding  </span><span class="s1"># Neural network layer types</span>
<span class="s2">from </span><span class="s0">tensorflow</span><span class="s3">.</span><span class="s0">keras</span><span class="s3">.</span><span class="s0">preprocessing</span><span class="s3">.</span><span class="s0">text </span><span class="s2">import </span><span class="s0">Tokenizer  </span><span class="s1"># Convert text to sequences of integers</span>
<span class="s2">from </span><span class="s0">tensorflow</span><span class="s3">.</span><span class="s0">keras</span><span class="s3">.</span><span class="s0">preprocessing</span><span class="s3">.</span><span class="s0">sequence </span><span class="s2">import </span><span class="s0">pad_sequences  </span><span class="s1"># Pad sequences to uniform length</span>

<span class="s1"># Download required NLTK data files</span>
<span class="s0">nltk</span><span class="s3">.</span><span class="s0">download</span><span class="s3">(</span><span class="s4">'punkt'</span><span class="s3">)  </span><span class="s1"># Tokenizer models for sentence and word splitting</span>
<span class="s0">nltk</span><span class="s3">.</span><span class="s0">download</span><span class="s3">(</span><span class="s4">'stopwords'</span><span class="s3">)  </span><span class="s1"># Lists of common stopwords in multiple languages</span>
<span class="s0">nltk</span><span class="s3">.</span><span class="s0">download</span><span class="s3">(</span><span class="s4">'wordnet'</span><span class="s3">)</span>
<span class="s1"># Ignore warnings to make life easier</span>
<span class="s2">import </span><span class="s0">warnings</span>
<span class="s0">warnings</span><span class="s3">.</span><span class="s0">filterwarnings</span><span class="s3">(</span><span class="s4">'ignore'</span><span class="s3">)</span>

<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">base </span><span class="s2">import </span><span class="s0">BaseEstimator</span><span class="s3">, </span><span class="s0">TransformerMixin</span>
<span class="s2">from </span><span class="s0">nltk</span><span class="s3">.</span><span class="s0">corpus </span><span class="s2">import </span><span class="s0">stopwords</span>
<span class="s2">from </span><span class="s0">nltk</span><span class="s3">.</span><span class="s0">stem </span><span class="s2">import </span><span class="s0">WordNetLemmatizer</span>
<span class="s2">from </span><span class="s0">nltk</span><span class="s3">.</span><span class="s0">tokenize </span><span class="s2">import </span><span class="s0">word_tokenize</span><hr class="ls0"><span class="s0">#%% 
df_train </span><span class="s5">= </span><span class="s0">pd</span><span class="s3">.</span><span class="s0">read_parquet</span><span class="s3">(</span><span class="s4">&quot;hf://datasets/stanfordnlp/imdb/plain_text/train-00000-of-00001.parquet&quot;</span><span class="s3">)</span>
<span class="s0">df_test </span><span class="s5">= </span><span class="s0">pd</span><span class="s3">.</span><span class="s0">read_parquet</span><span class="s3">(</span><span class="s4">&quot;hf://datasets/stanfordnlp/imdb/plain_text/test-00000-of-00001.parquet&quot;</span><span class="s3">)</span>
<span class="s0">df_unsupervised </span><span class="s5">= </span><span class="s0">pd</span><span class="s3">.</span><span class="s0">read_parquet</span><span class="s3">(</span><span class="s4">&quot;hf://datasets/stanfordnlp/imdb/plain_text/unsupervised-00000-of-00001.parquet&quot;</span><span class="s3">)</span><hr class="ls0"><span class="s0">#%% 
df_train</span><span class="s3">.</span><span class="s0">shape</span><hr class="ls0"><span class="s0">#%% 
df_test</span><span class="s3">.</span><span class="s0">shape</span><hr class="ls0"><span class="s0">#%% 
df_train</span><span class="s3">.</span><span class="s0">columns</span>
<hr class="ls0"><span class="s0">#%% 
df_test</span><span class="s3">.</span><span class="s0">columns</span>
<hr class="ls0"><span class="s0">#%% 
df_train</span><span class="s3">[</span><span class="s4">'label'</span><span class="s3">].</span><span class="s0">unique</span><span class="s3">()</span><hr class="ls0"><span class="s0">#%% 
df_test</span><span class="s3">[</span><span class="s4">'label'</span><span class="s3">].</span><span class="s0">unique</span><span class="s3">()</span><hr class="ls0"><span class="s0">#%% 
df_train</span><span class="s3">[</span><span class="s4">'text'</span><span class="s3">].</span><span class="s0">sample</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span><hr class="ls0"><span class="s0">#%% 
df_test</span><span class="s3">[</span><span class="s4">'text'</span><span class="s3">].</span><span class="s0">sample</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span><hr class="ls0"><span class="s0">#%% 
</span><span class="s2">class </span><span class="s0">pre_process_text</span><span class="s3">(</span><span class="s0">BaseEstimator</span><span class="s3">, </span><span class="s0">TransformerMixin</span><span class="s3">)</span><span class="s5">:</span>
    <span class="s2">def </span><span class="s0">__init__</span><span class="s3">(</span><span class="s0">self</span><span class="s3">)</span><span class="s5">:</span>
        <span class="s0">self</span><span class="s3">.</span><span class="s0">lemmatizer </span><span class="s5">= </span><span class="s0">WordNetLemmatizer</span><span class="s3">()</span>
        <span class="s0">self</span><span class="s3">.</span><span class="s0">stop_words </span><span class="s5">= </span><span class="s0">set</span><span class="s3">(</span><span class="s0">stopwords</span><span class="s3">.</span><span class="s0">words</span><span class="s3">(</span><span class="s4">'english'</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s0">fit</span><span class="s3">(</span><span class="s0">self</span><span class="s3">, </span><span class="s0">X</span><span class="s3">, </span><span class="s0">y</span><span class="s5">=</span><span class="s2">None</span><span class="s3">)</span><span class="s5">:</span>
        <span class="s2">return </span><span class="s0">self</span>

    <span class="s2">def </span><span class="s0">transform</span><span class="s3">(</span><span class="s0">self</span><span class="s3">, </span><span class="s0">X</span><span class="s3">, </span><span class="s0">y</span><span class="s5">=</span><span class="s2">None</span><span class="s3">)</span><span class="s5">:</span>
        <span class="s0">prep_sentences </span><span class="s5">= </span><span class="s3">[]</span>
        <span class="s2">for </span><span class="s0">text </span><span class="s2">in </span><span class="s0">X</span><span class="s5">:</span>
            <span class="s1"># Remove HTML tags (good practice)</span>
            <span class="s0">text </span><span class="s5">= </span><span class="s0">re</span><span class="s3">.</span><span class="s0">sub</span><span class="s3">(</span><span class="s4">r'&lt;.*?&gt;'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">, </span><span class="s0">text</span><span class="s3">)</span>

            <span class="s1"># Tokenize</span>
            <span class="s0">tokens </span><span class="s5">= </span><span class="s0">word_tokenize</span><span class="s3">(</span><span class="s0">text</span><span class="s3">)</span>

            <span class="s0">words_to_keep </span><span class="s5">= </span><span class="s3">{</span><span class="s4">&quot;not&quot;</span><span class="s3">, </span><span class="s4">&quot;no&quot;</span><span class="s3">, </span><span class="s4">&quot;against&quot;</span><span class="s3">, </span><span class="s4">&quot;down&quot;</span><span class="s3">,</span><span class="s4">&quot;no&quot;</span><span class="s3">, </span><span class="s4">&quot;nor&quot;</span><span class="s3">, </span><span class="s4">&quot;not&quot;</span><span class="s3">, </span><span class="s4">&quot;don&quot;</span><span class="s3">,</span><span class="s4">&quot;very&quot;</span><span class="s3">, </span><span class="s4">&quot;too&quot;</span><span class="s3">, </span><span class="s4">&quot;more&quot;</span><span class="s3">, </span><span class="s4">&quot;most&quot;</span><span class="s3">, </span><span class="s4">&quot;so&quot;</span><span class="s3">, </span><span class="s4">&quot;only&quot;</span><span class="s3">}</span>

            <span class="s1">#    Remove these words from the stop_words set</span>
            <span class="s1">#    We use .discard() which safely removes an item</span>
            <span class="s1">#    if it exists, and does nothing if it doesn't.</span>
            <span class="s2">for </span><span class="s0">word </span><span class="s2">in </span><span class="s0">words_to_keep</span><span class="s5">:</span>
                <span class="s0">self</span><span class="s3">.</span><span class="s0">stop_words</span><span class="s3">.</span><span class="s0">discard</span><span class="s3">(</span><span class="s0">word</span><span class="s3">)</span>

            <span class="s1"># Process tokens</span>
            <span class="s0">processed </span><span class="s5">= </span><span class="s3">[</span>
                <span class="s0">self</span><span class="s3">.</span><span class="s0">lemmatizer</span><span class="s3">.</span><span class="s0">lemmatize</span><span class="s3">(</span><span class="s0">token</span><span class="s3">.</span><span class="s0">lower</span><span class="s3">())</span>
                <span class="s2">for </span><span class="s0">token </span><span class="s2">in </span><span class="s0">tokens</span>
                <span class="s2">if </span><span class="s0">token</span><span class="s3">.</span><span class="s0">isalpha</span><span class="s3">() </span><span class="s2">and </span><span class="s0">token</span><span class="s3">.</span><span class="s0">lower</span><span class="s3">() </span><span class="s2">not in </span><span class="s0">self</span><span class="s3">.</span><span class="s0">stop_words</span>
            <span class="s3">]</span>

            <span class="s1"># Join back to a string</span>
            <span class="s0">prep_sentences</span><span class="s3">.</span><span class="s0">append</span><span class="s3">(</span><span class="s4">&quot; &quot;</span><span class="s3">.</span><span class="s0">join</span><span class="s3">(</span><span class="s0">processed</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s0">prep_sentences</span>

<span class="s2">class </span><span class="s0">Word2VecAverager</span><span class="s3">(</span><span class="s0">BaseEstimator</span><span class="s3">, </span><span class="s0">TransformerMixin</span><span class="s3">)</span><span class="s5">:</span>
    <span class="s2">def </span><span class="s0">__init__</span><span class="s3">(</span><span class="s0">self</span><span class="s3">, </span><span class="s0">w2v_model</span><span class="s3">)</span><span class="s5">:</span>
        <span class="s0">self</span><span class="s3">.</span><span class="s0">w2v_model </span><span class="s5">= </span><span class="s0">w2v_model</span>
        <span class="s0">self</span><span class="s3">.</span><span class="s0">vector_size </span><span class="s5">= </span><span class="s0">w2v_model</span><span class="s3">.</span><span class="s0">wv</span><span class="s3">.</span><span class="s0">vector_size</span>

    <span class="s2">def </span><span class="s0">fit</span><span class="s3">(</span><span class="s0">self</span><span class="s3">, </span><span class="s0">X</span><span class="s3">, </span><span class="s0">y</span><span class="s5">=</span><span class="s2">None</span><span class="s3">)</span><span class="s5">:</span>
        <span class="s2">return </span><span class="s0">self</span>

    <span class="s2">def </span><span class="s0">transform</span><span class="s3">(</span><span class="s0">self</span><span class="s3">, </span><span class="s0">X</span><span class="s3">)</span><span class="s5">:</span>
        <span class="s0">avg_vectors </span><span class="s5">= </span><span class="s3">[]</span>
        <span class="s1"># X is now a list of *pre-processed* strings</span>
        <span class="s2">for </span><span class="s0">doc </span><span class="s2">in </span><span class="s0">X</span><span class="s5">:</span>
            <span class="s0">doc_vectors </span><span class="s5">= </span><span class="s3">[]</span>
            <span class="s1"># We .split() the processed string</span>
            <span class="s2">for </span><span class="s0">word </span><span class="s2">in </span><span class="s0">doc</span><span class="s3">.</span><span class="s0">split</span><span class="s3">()</span><span class="s5">:</span>
                <span class="s2">if </span><span class="s0">word </span><span class="s2">in </span><span class="s0">self</span><span class="s3">.</span><span class="s0">w2v_model</span><span class="s3">.</span><span class="s0">wv</span><span class="s5">:</span>
                    <span class="s0">doc_vectors</span><span class="s3">.</span><span class="s0">append</span><span class="s3">(</span><span class="s0">self</span><span class="s3">.</span><span class="s0">w2v_model</span><span class="s3">.</span><span class="s0">wv</span><span class="s3">[</span><span class="s0">word</span><span class="s3">])</span>

            <span class="s2">if not </span><span class="s0">doc_vectors</span><span class="s5">:</span>
                <span class="s0">avg_vectors</span><span class="s3">.</span><span class="s0">append</span><span class="s3">(</span><span class="s0">np</span><span class="s3">.</span><span class="s0">zeros</span><span class="s3">(</span><span class="s0">self</span><span class="s3">.</span><span class="s0">vector_size</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s5">:</span>
                <span class="s0">avg_vectors</span><span class="s3">.</span><span class="s0">append</span><span class="s3">(</span><span class="s0">np</span><span class="s3">.</span><span class="s0">mean</span><span class="s3">(</span><span class="s0">doc_vectors</span><span class="s3">, </span><span class="s0">axis</span><span class="s5">=</span><span class="s6">0</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s0">np</span><span class="s3">.</span><span class="s0">array</span><span class="s3">(</span><span class="s0">avg_vectors</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span><hr class="ls0"><span class="s0">#%% 
df_train </span><span class="s5">= </span><span class="s0">pd</span><span class="s3">.</span><span class="s0">DataFrame</span><span class="s3">(</span><span class="s0">df_train</span><span class="s3">)</span>
<span class="s0">df_test </span><span class="s5">= </span><span class="s0">pd</span><span class="s3">.</span><span class="s0">DataFrame</span><span class="s3">(</span><span class="s0">df_test</span><span class="s3">)</span>

<span class="s0">X_train </span><span class="s5">= </span><span class="s0">df_train</span><span class="s3">[</span><span class="s4">'text'</span><span class="s3">]</span>
<span class="s0">y_train </span><span class="s5">= </span><span class="s0">df_train</span><span class="s3">[</span><span class="s4">'label'</span><span class="s3">].</span><span class="s0">values </span><span class="s1"># Use .values for numpy array</span>
<span class="s0">X_test </span><span class="s5">= </span><span class="s0">df_test</span><span class="s3">[</span><span class="s4">'text'</span><span class="s3">]</span>
<span class="s0">y_test </span><span class="s5">= </span><span class="s0">df_test</span><span class="s3">[</span><span class="s4">'label'</span><span class="s3">].</span><span class="s0">values</span><hr class="ls0"><span class="s0">#%% 
</span><span class="s1"># Instantiate your processor</span>
<span class="s0">pre_processor </span><span class="s5">= </span><span class="s0">pre_process_text</span><span class="s3">()</span>

<span class="s1"># Run the raw text through it</span>
<span class="s0">processed_X_train </span><span class="s5">= </span><span class="s0">pre_processor</span><span class="s3">.</span><span class="s0">fit_transform</span><span class="s3">(</span><span class="s0">X_train</span><span class="s3">)</span>

<span class="s1"># Tokenize the *processed* text for Word2Vec</span>
<span class="s0">tokenized_processed_train </span><span class="s5">= </span><span class="s3">[</span><span class="s0">doc</span><span class="s3">.</span><span class="s0">split</span><span class="s3">() </span><span class="s2">for </span><span class="s0">doc </span><span class="s2">in </span><span class="s0">processed_X_train</span><span class="s3">]</span>


<span class="s1"># 1. Use 100 dimensions. 50 is too small, 300 might be</span>
<span class="s1">#    a bit large for 25k reviews. 100 is the sweet spot.</span>
<span class="s0">embedding_dim </span><span class="s5">= </span><span class="s6">100</span>

<span class="s1"># 2. THIS IS THE MOST IMPORTANT CHANGE.</span>
<span class="s1">#    Filter out words that only appear 1-2 times.</span>
<span class="s1">#    They are often typos and just add noise.</span>
<span class="s0">min_word_count </span><span class="s5">= </span><span class="s6">3  </span><span class="s1"># You could even try 5</span>

<span class="s1"># 3. A window of 5 is a robust, standard choice.</span>
<span class="s0">window_size </span><span class="s5">= </span><span class="s6">5</span>

<span class="s1"># 4. Use Skip-gram (sg=1) for better quality vectors.</span>
<span class="s1"># 5. Use Negative Sampling (negative=5) for efficient training.</span>
<span class="s1"># 6. Use all your computer's cores to speed it up.</span>
<span class="s0">num_workers </span><span class="s5">= </span><span class="s6">4</span>

<span class="s0">word2vec_model </span><span class="s5">= </span><span class="s0">Word2Vec</span><span class="s3">(</span>
    <span class="s0">sentences</span><span class="s5">=</span><span class="s0">tokenized_processed_train</span><span class="s3">,</span>
    <span class="s0">vector_size</span><span class="s5">=</span><span class="s0">embedding_dim</span><span class="s3">,</span>
    <span class="s0">window</span><span class="s5">=</span><span class="s0">window_size</span><span class="s3">,</span>
    <span class="s0">min_count</span><span class="s5">=</span><span class="s0">min_word_count</span><span class="s3">,</span>
    <span class="s0">workers</span><span class="s5">=</span><span class="s0">num_workers</span><span class="s3">,</span>
    <span class="s0">sg</span><span class="s5">=</span><span class="s6">1</span><span class="s3">,       </span><span class="s1"># Use Skip-gram</span>
    <span class="s0">negative</span><span class="s5">=</span><span class="s6">5  </span><span class="s1"># Use Negative Sampling</span>
<span class="s3">)</span>

<span class="s0">classsifier </span><span class="s5">= </span><span class="s0">Pipeline</span><span class="s3">([</span>
    <span class="s3">(</span><span class="s4">&quot;preprocessor&quot;</span><span class="s3">, </span><span class="s0">pre_processor</span><span class="s3">),  </span><span class="s1"># This will process raw text</span>
    <span class="s3">(</span><span class="s4">&quot;vectorizer&quot;</span><span class="s3">, </span><span class="s0">Word2VecAverager</span><span class="s3">(</span><span class="s0">w2v_model</span><span class="s5">=</span><span class="s0">word2vec_model</span><span class="s3">)), </span><span class="s1"># This averages the processed text</span>
    <span class="s3">(</span><span class="s4">&quot;classifier&quot;</span><span class="s3">, </span><span class="s0">SVC</span><span class="s3">(</span><span class="s0">kernel</span><span class="s5">=</span><span class="s4">&quot;linear&quot;</span><span class="s3">)) </span><span class="s1"># This classifies the vectors</span>
<span class="s3">])</span>



<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s0">kf </span><span class="s5">= </span><span class="s0">StratifiedKFold</span><span class="s3">(</span><span class="s0">n_splits</span><span class="s5">=</span><span class="s6">5</span><span class="s3">, </span><span class="s0">shuffle</span><span class="s5">=</span><span class="s2">True</span><span class="s3">, </span><span class="s0">random_state</span><span class="s5">=</span><span class="s6">42</span><span class="s3">)</span>
<span class="s1"># X_train: your training features</span>
<span class="s1"># y_train: your training labels (target variable)</span>
<span class="s1"># X_test, y_test: your separate test set (not used in cross-validation)</span>
<span class="s0">X_train </span><span class="s5">= </span><span class="s0">df_train</span><span class="s3">[</span><span class="s4">'text'</span><span class="s3">]</span>
<span class="s0">y_train </span><span class="s5">= </span><span class="s0">df_train</span><span class="s3">[</span><span class="s4">'label'</span><span class="s3">]</span>
<span class="s0">X_test </span><span class="s5">= </span><span class="s0">df_test</span><span class="s3">[</span><span class="s4">'text'</span><span class="s3">]</span>
<span class="s0">y_test </span><span class="s5">= </span><span class="s0">df_test</span><span class="s3">[</span><span class="s4">'label'</span><span class="s3">]</span>
<span class="s0">acc_score </span><span class="s5">= </span><span class="s3">[]</span>
<span class="s1"># We need to store the scores for each fold</span>
<span class="s0">fold_accuracies </span><span class="s5">= </span><span class="s3">[]</span>
<span class="s0">fold_precisions </span><span class="s5">= </span><span class="s3">[]</span>
<span class="s0">fold_recalls </span><span class="s5">= </span><span class="s3">[]</span>
<span class="s0">fold_f1s </span><span class="s5">= </span><span class="s3">[]</span>
<span class="s1"># Split the TRAINING data only</span>
<span class="s2">for </span><span class="s0">train_idx</span><span class="s3">, </span><span class="s0">val_idx </span><span class="s2">in </span><span class="s0">kf</span><span class="s3">.</span><span class="s0">split</span><span class="s3">(</span><span class="s0">X_train</span><span class="s3">, </span><span class="s0">y_train</span><span class="s3">)</span><span class="s5">:</span>
    <span class="s1"># Split training data into train and validation folds</span>
    <span class="s0">X_fold_train</span><span class="s3">, </span><span class="s0">X_fold_val </span><span class="s5">= </span><span class="s0">X_train</span><span class="s3">.</span><span class="s0">iloc</span><span class="s3">[</span><span class="s0">train_idx</span><span class="s3">], </span><span class="s0">X_train</span><span class="s3">.</span><span class="s0">iloc</span><span class="s3">[</span><span class="s0">val_idx</span><span class="s3">]</span>
    <span class="s0">y_fold_train</span><span class="s3">, </span><span class="s0">y_fold_val </span><span class="s5">= </span><span class="s0">y_train</span><span class="s3">.</span><span class="s0">iloc</span><span class="s3">[</span><span class="s0">train_idx</span><span class="s3">], </span><span class="s0">y_train</span><span class="s3">.</span><span class="s0">iloc</span><span class="s3">[</span><span class="s0">val_idx</span><span class="s3">]</span>

    <span class="s0">classsifier</span><span class="s3">.</span><span class="s0">fit</span><span class="s3">(</span><span class="s0">X_fold_train</span><span class="s3">, </span><span class="s0">y_fold_train</span><span class="s3">) </span><span class="s1">#we then only fit the training data (note that we oapply the text_clf pipeline object, rather than having to go through each function separately)</span>
    <span class="s0">predictions </span><span class="s5">= </span><span class="s0">classsifier</span><span class="s3">.</span><span class="s0">predict</span><span class="s3">(</span><span class="s0">X_fold_val</span><span class="s3">) </span><span class="s1">#and can predict on the test data (similar to above, we can predict using the pipeline directly)</span>
    <span class="s0">acc </span><span class="s5">= </span><span class="s0">accuracy_score</span><span class="s3">(</span><span class="s0">y_fold_val</span><span class="s3">, </span><span class="s0">predictions</span><span class="s3">)</span>
    <span class="s0">precision </span><span class="s5">= </span><span class="s0">precision_score</span><span class="s3">(</span><span class="s0">y_fold_val</span><span class="s3">, </span><span class="s0">predictions</span><span class="s3">)</span>
    <span class="s0">recall </span><span class="s5">= </span><span class="s0">recall_score</span><span class="s3">(</span><span class="s0">y_fold_val</span><span class="s3">, </span><span class="s0">predictions</span><span class="s3">)</span>
    <span class="s0">f1 </span><span class="s5">= </span><span class="s0">f1_score</span><span class="s3">(</span><span class="s0">y_fold_val</span><span class="s3">, </span><span class="s0">predictions</span><span class="s3">)</span>
    <span class="s0">print</span><span class="s3">(</span><span class="s0">classification_report</span><span class="s3">(</span><span class="s0">y_fold_val</span><span class="s3">, </span><span class="s0">predictions</span><span class="s3">))</span>

    <span class="s0">fold_accuracies</span><span class="s3">.</span><span class="s0">append</span><span class="s3">(</span><span class="s0">acc</span><span class="s3">)</span>
    <span class="s0">fold_precisions</span><span class="s3">.</span><span class="s0">append</span><span class="s3">(</span><span class="s0">precision</span><span class="s3">)</span>
    <span class="s0">fold_recalls</span><span class="s3">.</span><span class="s0">append</span><span class="s3">(</span><span class="s0">recall</span><span class="s3">)</span>
    <span class="s0">fold_f1s</span><span class="s3">.</span><span class="s0">append</span><span class="s3">(</span><span class="s0">f1</span><span class="s3">)</span>

<span class="s0">print</span><span class="s3">(</span><span class="s4">&quot;\n--- Cross-Validation Results (5 Folds) ---&quot;</span><span class="s3">)</span>
<span class="s0">print</span><span class="s3">(</span><span class="s4">f&quot;Average Accuracy:  {</span><span class="s0">np</span><span class="s3">.</span><span class="s0">mean</span><span class="s3">(</span><span class="s0">fold_accuracies</span><span class="s3">)</span><span class="s4">:.4f} (+/- {</span><span class="s0">np</span><span class="s3">.</span><span class="s0">std</span><span class="s3">(</span><span class="s0">fold_accuracies</span><span class="s3">)</span><span class="s4">:.4f})&quot;</span><span class="s3">)</span>
<span class="s0">print</span><span class="s3">(</span><span class="s4">f&quot;Average Precision: {</span><span class="s0">np</span><span class="s3">.</span><span class="s0">mean</span><span class="s3">(</span><span class="s0">fold_precisions</span><span class="s3">)</span><span class="s4">:.4f}&quot;</span><span class="s3">)</span>
<span class="s0">print</span><span class="s3">(</span><span class="s4">f&quot;Average Recall:    {</span><span class="s0">np</span><span class="s3">.</span><span class="s0">mean</span><span class="s3">(</span><span class="s0">fold_recalls</span><span class="s3">)</span><span class="s4">:.4f}&quot;</span><span class="s3">)</span>
<span class="s0">print</span><span class="s3">(</span><span class="s4">f&quot;Average F1-Score:  {</span><span class="s0">np</span><span class="s3">.</span><span class="s0">mean</span><span class="s3">(</span><span class="s0">fold_f1s</span><span class="s3">)</span><span class="s4">:.4f}&quot;</span><span class="s3">)</span><hr class="ls0"><span class="s0">#%% 
</span><span class="s2">import </span><span class="s0">numpy </span><span class="s2">as </span><span class="s0">np</span>
<span class="s2">import </span><span class="s0">pandas </span><span class="s2">as </span><span class="s0">pd</span>
<span class="s2">import </span><span class="s0">matplotlib</span><span class="s3">.</span><span class="s0">pyplot </span><span class="s2">as </span><span class="s0">plt</span>
<span class="s2">import </span><span class="s0">seaborn </span><span class="s2">as </span><span class="s0">sns</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">model_selection </span><span class="s2">import </span><span class="s0">StratifiedKFold</span>
<span class="s2">from </span><span class="s0">sklearn</span><span class="s3">.</span><span class="s0">metrics </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s0">accuracy_score</span><span class="s3">, </span><span class="s0">precision_score</span><span class="s3">, </span><span class="s0">recall_score</span><span class="s3">, </span><span class="s0">f1_score</span><span class="s3">,</span>
    <span class="s0">classification_report</span><span class="s3">, </span><span class="s0">confusion_matrix</span>
<span class="s3">)</span>

<span class="s1"># --- Plot 1: Box Plot of CV Scores ---</span>
<span class="s1"># This plot shows the stability of your model.</span>
<span class="s1"># A small box means your model is very consistent.</span>
<span class="s0">cv_metrics_df </span><span class="s5">= </span><span class="s0">pd</span><span class="s3">.</span><span class="s0">DataFrame</span><span class="s3">({</span>
    <span class="s4">'Accuracy'</span><span class="s5">: </span><span class="s0">fold_accuracies</span><span class="s3">,</span>
    <span class="s4">'Precision'</span><span class="s5">: </span><span class="s0">fold_precisions</span><span class="s3">,</span>
    <span class="s4">'Recall'</span><span class="s5">: </span><span class="s0">fold_recalls</span><span class="s3">,</span>
    <span class="s4">'F1-Score'</span><span class="s5">: </span><span class="s0">fold_f1s</span>
<span class="s3">})</span>


<span class="s0">print</span><span class="s3">(</span><span class="s4">&quot;-------------------------------------------------------------------&quot;</span><span class="s3">)</span>

<span class="s1"># ==============================================================================</span>
<span class="s1"># PART 2: FINAL TRAINING AND TESTING (To get final report)</span>
<span class="s1"># ==============================================================================</span>
<span class="s0">print</span><span class="s3">(</span><span class="s4">&quot;\n--- Starting Final Model Training ---&quot;</span><span class="s3">)</span>

<span class="s1"># Now that we're confident, train the model ONE time on ALL training data</span>
<span class="s0">classsifier</span><span class="s3">.</span><span class="s0">fit</span><span class="s3">(</span><span class="s0">X_train</span><span class="s3">, </span><span class="s0">y_train</span><span class="s3">)</span>

<span class="s1"># Now, predict ONE time on the unseen test set</span>
<span class="s0">final_predictions </span><span class="s5">= </span><span class="s0">classsifier</span><span class="s3">.</span><span class="s0">predict</span><span class="s3">(</span><span class="s0">X_test</span><span class="s3">)</span>

<span class="s1"># Get the final scores</span>
<span class="s0">final_acc </span><span class="s5">= </span><span class="s0">accuracy_score</span><span class="s3">(</span><span class="s0">y_test</span><span class="s3">, </span><span class="s0">final_predictions</span><span class="s3">)</span>
<span class="s0">final_precision </span><span class="s5">= </span><span class="s0">precision_score</span><span class="s3">(</span><span class="s0">y_test</span><span class="s3">, </span><span class="s0">final_predictions</span><span class="s3">)</span>
<span class="s0">final_recall </span><span class="s5">= </span><span class="s0">recall_score</span><span class="s3">(</span><span class="s0">y_test</span><span class="s3">, </span><span class="s0">final_predictions</span><span class="s3">)</span>
<span class="s0">final_f1 </span><span class="s5">= </span><span class="s0">f1_score</span><span class="s3">(</span><span class="s0">y_test</span><span class="s3">, </span><span class="s0">final_predictions</span><span class="s3">)</span>

<span class="s0">print</span><span class="s3">(</span><span class="s4">&quot;\n--- Final Test Set Results ---&quot;</span><span class="s3">)</span>
<span class="s0">print</span><span class="s3">(</span><span class="s0">classification_report</span><span class="s3">(</span><span class="s0">y_test</span><span class="s3">, </span><span class="s0">final_predictions</span><span class="s3">))</span>

<span class="s1"># --- Plot 2: Final Confusion Matrix ---</span>
<span class="s0">cm </span><span class="s5">= </span><span class="s0">confusion_matrix</span><span class="s3">(</span><span class="s0">y_test</span><span class="s3">, </span><span class="s0">final_predictions</span><span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">figure</span><span class="s3">(</span><span class="s0">figsize</span><span class="s5">=</span><span class="s3">(</span><span class="s6">7</span><span class="s3">, </span><span class="s6">5</span><span class="s3">))</span>
<span class="s0">sns</span><span class="s3">.</span><span class="s0">heatmap</span><span class="s3">(</span>
    <span class="s0">cm</span><span class="s3">, </span><span class="s0">annot</span><span class="s5">=</span><span class="s2">True</span><span class="s3">, </span><span class="s0">fmt</span><span class="s5">=</span><span class="s4">'d'</span><span class="s3">, </span><span class="s0">cmap</span><span class="s5">=</span><span class="s4">'Blues'</span><span class="s3">,</span>
    <span class="s0">xticklabels</span><span class="s5">=</span><span class="s3">[</span><span class="s4">'Predicted Negative'</span><span class="s3">, </span><span class="s4">'Predicted Positive'</span><span class="s3">],</span>
    <span class="s0">yticklabels</span><span class="s5">=</span><span class="s3">[</span><span class="s4">'Actual Negative'</span><span class="s3">, </span><span class="s4">'Actual Positive'</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">title</span><span class="s3">(</span><span class="s4">'Final Model Confusion Matrix'</span><span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">ylabel</span><span class="s3">(</span><span class="s4">'Actual Label'</span><span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">xlabel</span><span class="s3">(</span><span class="s4">'Predicted Label'</span><span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">show</span><span class="s3">()</span>

<span class="s1"># --- Plot 3: Final Scores Bar Chart ---</span>
<span class="s0">final_metrics_dict </span><span class="s5">= </span><span class="s3">{</span>
    <span class="s4">'Accuracy'</span><span class="s5">: </span><span class="s0">final_acc</span><span class="s3">,</span>
    <span class="s4">'Precision'</span><span class="s5">: </span><span class="s0">final_precision</span><span class="s3">,</span>
    <span class="s4">'Recall'</span><span class="s5">: </span><span class="s0">final_recall</span><span class="s3">,</span>
    <span class="s4">'F1-Score'</span><span class="s5">: </span><span class="s0">final_f1</span>
<span class="s3">}</span>
<span class="s0">metric_names </span><span class="s5">= </span><span class="s0">list</span><span class="s3">(</span><span class="s0">final_metrics_dict</span><span class="s3">.</span><span class="s0">keys</span><span class="s3">())</span>
<span class="s0">metric_values </span><span class="s5">= </span><span class="s0">list</span><span class="s3">(</span><span class="s0">final_metrics_dict</span><span class="s3">.</span><span class="s0">values</span><span class="s3">())</span>

<span class="s0">plt</span><span class="s3">.</span><span class="s0">figure</span><span class="s3">(</span><span class="s0">figsize</span><span class="s5">=</span><span class="s3">(</span><span class="s6">8</span><span class="s3">, </span><span class="s6">5</span><span class="s3">))</span>
<span class="s0">barplot </span><span class="s5">= </span><span class="s0">sns</span><span class="s3">.</span><span class="s0">barplot</span><span class="s3">(</span><span class="s0">x</span><span class="s5">=</span><span class="s0">metric_names</span><span class="s3">, </span><span class="s0">y</span><span class="s5">=</span><span class="s0">metric_values</span><span class="s3">, </span><span class="s0">palette</span><span class="s5">=</span><span class="s4">'viridis'</span><span class="s3">)</span>
<span class="s2">for </span><span class="s0">i</span><span class="s3">, </span><span class="s0">v </span><span class="s2">in </span><span class="s0">enumerate</span><span class="s3">(</span><span class="s0">metric_values</span><span class="s3">)</span><span class="s5">:</span>
    <span class="s0">barplot</span><span class="s3">.</span><span class="s0">text</span><span class="s3">(</span><span class="s0">i</span><span class="s3">, </span><span class="s0">v </span><span class="s5">+ </span><span class="s6">0.01</span><span class="s3">, </span><span class="s4">f&quot;{</span><span class="s0">v</span><span class="s4">:.2f}&quot;</span><span class="s3">, </span><span class="s0">ha</span><span class="s5">=</span><span class="s4">'center'</span><span class="s3">, </span><span class="s0">fontweight</span><span class="s5">=</span><span class="s4">'bold'</span><span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">title</span><span class="s3">(</span><span class="s4">'Final Model Performance Metrics on Test Set'</span><span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">ylabel</span><span class="s3">(</span><span class="s4">'Score'</span><span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">ylim</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">)</span>
<span class="s0">plt</span><span class="s3">.</span><span class="s0">show</span><span class="s3">()</span></pre>
</body>
</html>